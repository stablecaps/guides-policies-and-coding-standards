# Auto Semantic Versioning for Python

## Overview
This details how to automate semantic versioning in Python repos using
1. [python-semantic-release](https://github.com/python-semantic-release/python-semantic-release)
2. [semantic-prs](https://github.com/Ezard/semantic-prs)
3. pre-commit????? [](https://github.com/compilerla/conventional-pre-commit)

## method
1. Setup Semantic PRs as per [the guide](https://github.com/Ezard/semantic-prs). This only has to be done once for the whole repo. It will ensure that PRs use the required syntax for conventional commits.
2. Install pre-commit hook using [conventional-pre-commit
](https://github.com/compilerla/conventional-pre-commit) with the command `pre-commit install --hook-type commit-msg`.
```yaml
---
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.1.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args: []
```

3. Install python-semantic-release using poetry `poetry add python-semantic-release`
4. Configure the starting semantic version in `__init__.py` and `pyproject.toml`

#### Example __init__.py
```python
"""The init.py."""

__version__ = "0.3.0"

```

#### Example pyproject.toml
```python
[tool.poetry]
name = "helpohelpo"
version = "0.3.0"
description = "A library of python helpers"
authors = ["Stablecaps <114529342+darkpandarts@users.noreply.github.com>"]
license = "LICENSE"
readme = "README.md"
keywords=[
    "python3",
    "helpers",
]
classifiers = [
    "Programming Language :: Python :: 3",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
]
packages = [{include = "helpo"}]


[tool.poetry.dependencies]
python = "^3.8"

python-semantic-release = "^8.7.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

[tool.poetry.urls]
"Homepage" = "https://github.com/stablecaps/helpohelpo"
"Bug Tracker" = "https://github.com/stablecaps/helpohelpo/issues"

#############################################
[tool.semantic_release]
version_variables = [
    "./__init__.py:__version__",
    "./pyproject.toml:version"
]
assets = []
version_source = "commit"
commit_message = "{version}\n\nAutomatically generated by python-semantic-release"
commit_parser = "angular"
logging_use_named_masks = false
major_on_zero = false
tag_format = "{version}"
#
build_command = "poetry build"

[tool.semantic_release.branches.master]
match = "master"
prerelease_token = "rc"
prerelease = false

[tool.semantic_release.changelog]
template_dir = "templates"
changelog_file = "CHANGELOG.md"
exclude_commit_patterns = []

[tool.semantic_release.changelog.environment]
block_start_string = "{%"
block_end_string = "%}"
variable_start_string = "{{"
variable_end_string = "}}"
comment_start_string = "{#"
comment_end_string = "#}"
trim_blocks = false
lstrip_blocks = false
newline_sequence = "\n"
keep_trailing_newline = false
extensions = []
autoescape = true

[tool.semantic_release.commit_author]
env = "GIT_COMMIT_AUTHOR"
default = "semantic-release <semantic-release>"

[tool.semantic_release.commit_parser_options]
allowed_tags = ["build", "chore", "ci", "docs", "feat", "fix", "perf", "style", "refactor", "test"]
minor_tags = ["feat"]
patch_tags = ["fix", "perf"]

[tool.semantic_release.remote]
name = "origin"
type = "github"
ignore_token_for_push = true

[tool.semantic_release.remote.token]
env = "GH_TOKEN"

[tool.semantic_release.publish]
dist_glob_patterns = ["dist/*"]
upload_to_vcs_release = true
```

### Example GHA publish pipeline
```yaml
on:
    push:
      branches:
        - feature/setup-semvar-pipeline
        - master
    pull_request:
      branches: [ main ]

# TODO: insert linting checks & tests
jobs:
  build-test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.8"]
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: "poetry"

    - name: Install dependencies
      run: |
        poetry install

    # - name: Run tests
    #   run: |
    #     poetry run pytest

  publish:
    needs: ['build-test']
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && !contains(github.event.head_commit.message, 'chore(release):')
    name: upload release to PyPI
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.8"]
    permissions:
      # IMPORTANT: this permission is mandatory for trusted publishing
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install dependencies & build package
        run: |
          curl -sSL https://install.python-poetry.org | python3 -

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "poetry"

      - name: Install dependencies
        run: poetry install

      - name: Prepare package for release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          poetry run semantic-release version
          poetry run semantic-release publish

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
```

## Links
1. [https://py-pkgs.org/08-ci-cd.html#continuous-integration-and-deployment](https://py-pkgs.org/08-ci-cd.html#continuous-integration-and-deployment)
2. [Semantic release with Python, Poetry & GitHub Actions](https://dev.to/mestrak/semantic-release-with-python-poetry-github-actions-20nn)
3. [Semantic Release to automate publishing to PyPI](https://guicommits.com/semantic-release-to-automate-versioning-and-publishing-to-pypi-with-github-actions/)
4. [Python Semantic Release docs](https://python-semantic-release.readthedocs.io/en/latest/)
5. [7. Releasing and versioning](https://py-pkgs.org/07-releasing-versioning.html)
6. [Publishing our Python Packages](https://carpentries-incubator.github.io/python_packaging/05-publishing.html)